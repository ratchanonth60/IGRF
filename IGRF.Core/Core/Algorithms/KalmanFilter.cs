using System;

namespace IGRF_Interface.Core.Algorithms // ???????????? Folder ????? .Services ??? ???????????????? Form1
{
    public class KalmanFilter
    {
        // --- Configuration Parameters (??????????????????) ---

        /// <summary>
        /// A: System Model (State Transition). 
        /// ???? = 1 ????????????????????
        /// </summary>
        public double A { get; set; } = 1;

        /// <summary>
        /// H: Measurement Model (Scale Factor). 
        /// ???? = 1 ????????? Sensor ????????????????? State
        /// </summary>
        public double H { get; set; } = 1;

        /// <summary>
        /// Q: Process Noise Covariance (??????????????????)
        /// - ???????: ?????????????????? ?????????????? (Output ??????? Delay)
        /// - ??????: ?????????????????????????????? (Output ??????????)
        /// </summary>
        public double Q { get; set; } = 1;

        /// <summary>
        /// R: Measurement Noise Covariance (?????????????? Sensor)
        /// - ???????: ??????????? Sensor ??? (????????)
        /// - ??????: ???????? Sensor (????????, ?????????)
        /// </summary>
        public double R { get; set; } = 100;
        public double R_Val
        {
            get { return R; }
            set { R = value; }
        }

        // --- State Variables (????????????????????) ---

        /// <summary>
        /// X: Estimated State (??????????????????????)
        /// </summary>
        public double State { get; private set; }

        /// <summary>
        /// P: Error Covariance (?????????????????????????????)
        /// </summary>
        public double Covariance { get; private set; }

        /// <summary>
        /// Constructor
        /// </summary>
        /// <param name="initialState">??????????? (x0)</param>
        /// <param name="initialCovariance">??? P ???????? (???? 1-10)</param>
        /// <param name="q">Process Noise (Default: 1)</param>
        /// <param name="r">Measurement Noise (Default: 100)</param>
        public KalmanFilter(double initialState, double initialCovariance = 1, double q = 1, double r = 100)
        {
            this.State = initialState;
            this.Covariance = initialCovariance;
            this.Q = q;
            this.R = r;
        }

        /// <summary>
        /// ?????????????????? (Standard Predict + Update)
        /// </summary>
        /// <param name="measurement">???????????????? Sensor (z)</param>
        /// <param name="controlInput">Control Input (u) - ??? 0 ??????????????????????</param>
        /// <returns>?????????????? (Filtered State)</returns>
        public double Filter(double measurement, double controlInput = 0)
        {
            // 1. Time Update (Prediction) - ??????????
            // x = A*x + B*u (???????? B ????????? 1 ????? controlInput)
            double x_pred = (A * State) + controlInput;
            double p_pred = (A * Covariance * A) + Q;

            // 2. Measurement Update (Correction) - ?????????????????
            // K = Kalman Gain
            double K = (p_pred * H) / ((H * p_pred * H) + R);

            // Update State (x)
            State = x_pred + K * (measurement - (H * x_pred));

            // Update Covariance (P)
            Covariance = (1 - (K * H)) * p_pred;

            return State;
        }

        /// <summary>
        /// ????????? Filter ???? (???? ???? Sensor ???????????????)
        /// </summary>
        public void Reset(double initialState, double initialCovariance = 1)
        {
            this.State = initialState;
            this.Covariance = initialCovariance;
        }
    }
}